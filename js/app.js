(()=>{const t=document.getElementById("simulationCanvas"),e=t.getContext("2d");function i(){t.width=window.innerWidth,t.height=window.innerHeight}window.addEventListener("resize",i),i();const h={x:0,y:0,scale:1,isDragging:!1,lastMouseX:0,lastMouseY:0},l=new class{constructor(){this.x=0,this.y=0,this.heading=0,this.wheelbase=3.8,this.width=2,this.length=this.wheelbase+.6,this.speed=0,this.acceleration=0,this.maxSpeed=20,this.maxAcceleration=5,this.maxDeceleration=8,this.maxSteeringAngle=Math.PI/4,this.steeringAngle=0,this.color="#3498db",this.hitchX=-this.length/2,this.hitchY=0}update(t){if(this.speed+=this.acceleration*t,this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<0&&(this.speed=0),Math.abs(this.speed)>.001){const e=0!==this.steeringAngle?this.wheelbase/Math.tan(this.steeringAngle):1/0,i=this.speed/e;this.heading+=i*t,this.heading=this.heading%(2*Math.PI),this.heading<0&&(this.heading+=2*Math.PI),this.x+=this.speed*Math.cos(this.heading)*t,this.y+=this.speed*Math.sin(this.heading)*t}}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.heading);const e=-this.wheelbase/2,i=this.wheelbase/2;t.fillStyle=this.color,t.fillRect(-this.length/2,-this.width/2,this.length,this.width),t.fillStyle="#e74c3c",t.beginPath(),t.moveTo(this.length/2,0),t.lineTo(this.length/2-.3,-.3),t.lineTo(this.length/2-.3,.3),t.fill();const h=.5,l=.8;t.fillStyle="#2c3e50",t.fillRect(e-.4,-this.width/2-h,l,h),t.fillRect(e-.4,this.width/2,l,h),t.save(),t.translate(i,-this.width/2-.25),t.rotate(this.steeringAngle),t.fillRect(-.4,-.25,l,h),t.restore(),t.save(),t.translate(i,this.width/2+.25),t.rotate(this.steeringAngle),t.fillRect(-.4,-.25,l,h),t.restore(),t.save(),t.translate(this.hitchX,this.hitchY),t.fillStyle="#e74c3c",t.beginPath(),t.arc(0,0,.2,0,2*Math.PI),t.fill(),t.restore(),t.strokeStyle="#3c4de7",t.lineWidth=.1,t.beginPath(),t.moveTo(0,0),t.lineTo(2,0),t.stroke(),t.beginPath(),t.moveTo(2,0),t.lineTo(1.8,-.1),t.lineTo(1.8,.1),t.closePath(),t.fillStyle="#3c4de7",t.fill();const s=.15;t.beginPath(),t.arc(e,0,s,0,2*Math.PI),t.fillStyle="#e67e22",t.fill(),t.beginPath(),t.arc(i,0,s,0,2*Math.PI),t.fillStyle="#9b59b6",t.fill(),t.beginPath(),t.arc(0,0,s,0,2*Math.PI),t.fillStyle="#2ecc71",t.fill(),t.restore()}},s=new class{constructor(t){this.vehicle=t,this.x=t.x-t.length/2-1,this.y=t.y,this.heading=t.heading,this.length=3,this.width=1.8,this.hitchX=this.length/2,this.hitchY=0,this.hitchLength=1,this.color="#27ae60"}update(t){const e=this.vehicle.x+Math.cos(this.vehicle.heading)*this.vehicle.hitchX-Math.sin(this.vehicle.heading)*this.vehicle.hitchY,i=this.vehicle.y+Math.sin(this.vehicle.heading)*this.vehicle.hitchX+Math.cos(this.vehicle.heading)*this.vehicle.hitchY,h=e-(this.x+Math.cos(this.heading)*this.hitchX-Math.sin(this.heading)*this.hitchY),l=i-(this.y+Math.sin(this.heading)*this.hitchX+Math.cos(this.heading)*this.hitchY),s=(Math.sqrt(h*h+l*l),Math.atan2(l,h)),n=s-this.heading,a=Math.atan2(Math.sin(n),Math.cos(n));this.heading+=a*Math.min(1,this.vehicle.speed*t),this.x=e-Math.cos(this.heading)*this.hitchX+Math.sin(this.heading)*this.hitchY-Math.cos(s)*this.hitchLength,this.y=i-Math.sin(this.heading)*this.hitchX-Math.cos(this.heading)*this.hitchY-Math.sin(s)*this.hitchLength}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.heading),t.fillStyle=this.color,t.fillRect(-this.length/2,-this.width/2,this.length,this.width),t.fillStyle="#2c3e50",t.fillRect(-this.length/4,-this.width/2-.3,.8,.3),t.fillRect(-this.length/4,this.width/2,.8,.3),t.fillStyle="#e74c3c",t.beginPath(),t.arc(this.hitchX,this.hitchY,.2,0,2*Math.PI),t.fill(),t.restore(),t.beginPath();const e=this.vehicle.x+Math.cos(this.vehicle.heading)*this.vehicle.hitchX-Math.sin(this.vehicle.heading)*this.vehicle.hitchY,i=this.vehicle.y+Math.sin(this.vehicle.heading)*this.vehicle.hitchX+Math.cos(this.vehicle.heading)*this.vehicle.hitchY,h=this.x+Math.cos(this.heading)*this.hitchX-Math.sin(this.heading)*this.hitchY,l=this.y+Math.sin(this.heading)*this.hitchX+Math.cos(this.heading)*this.hitchY;t.strokeStyle="#7f8c8d",t.lineWidth=.1,t.moveTo(e,i),t.lineTo(h,l),t.stroke()}}(l),n=new class{constructor(t){this.vehicle=t,this.keys={ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1," ":!1},window.addEventListener("keydown",(t=>this.handleKeyDown(t))),window.addEventListener("keyup",(t=>this.handleKeyUp(t)))}handleKeyDown(t){this.keys.hasOwnProperty(t.key)&&(this.keys[t.key]=!0,t.preventDefault())}handleKeyUp(t){this.keys.hasOwnProperty(t.key)&&(this.keys[t.key]=!1,t.preventDefault())}update(t){this.keys.ArrowLeft&&!this.keys.ArrowRight?this.vehicle.steeringAngle=-this.vehicle.maxSteeringAngle:this.keys.ArrowRight&&!this.keys.ArrowLeft?this.vehicle.steeringAngle=this.vehicle.maxSteeringAngle:this.vehicle.steeringAngle=0,this.keys[" "]?this.vehicle.acceleration=-this.vehicle.maxDeceleration:this.keys.ArrowUp&&!this.keys.ArrowDown?this.vehicle.acceleration=this.vehicle.maxAcceleration:this.keys.ArrowDown&&!this.keys.ArrowUp?this.vehicle.acceleration=-this.vehicle.maxDeceleration:Math.abs(this.vehicle.speed)<.1?(this.vehicle.acceleration=0,this.vehicle.speed=0):this.vehicle.acceleration=2*-Math.sign(this.vehicle.speed)}}(l);t.addEventListener("wheel",(e=>{e.preventDefault();const i=e.deltaY>0?.9:1.1,l=t.getBoundingClientRect(),s=e.clientX-l.left,n=e.clientY-l.top,a=(s-t.width/2)/h.scale+h.x,o=(n-t.height/2)/h.scale+h.y;h.scale*=i,h.scale=Math.max(.1,Math.min(h.scale,50)),h.x=a-(s-t.width/2)/h.scale,h.y=o-(n-t.height/2)/h.scale})),t.addEventListener("mousedown",(t=>{2===t.button&&(h.isDragging=!0,h.lastMouseX=t.clientX,h.lastMouseY=t.clientY)})),t.addEventListener("mousemove",(t=>{if(h.isDragging){const e=t.clientX-h.lastMouseX,i=t.clientY-h.lastMouseY;h.x-=e/h.scale,h.y-=i/h.scale,h.lastMouseX=t.clientX,h.lastMouseY=t.clientY}})),t.addEventListener("mouseup",(t=>{2===t.button&&(h.isDragging=!1)})),t.addEventListener("contextmenu",(t=>{t.preventDefault()}));let a=[],o=[],r=0;function c(t,e,i,h){if(e>=i-1)return-1;let l=0,s=-1;const n=t[e],a=t[i];for(let o=e+1;o<i;o++){const e=t[o],i=g(e.x,e.y,n.x,n.y,a.x,a.y);i>l&&i>h&&(l=i,s=o)}return s}function g(t,e,i,h,l,s){const n=l-i,a=s-h,o=n*n+a*a;let r,c,g=-1;0!==o&&(g=((t-i)*n+(e-h)*a)/o),g<0?(r=i,c=h):g>1?(r=l,c=s):(r=i+g*n,c=h+g*a);const d=t-r,f=e-c;return Math.sqrt(d*d+f*f)}function d(t,e,i){if(i.length<2)return 1/0;let h=1/0;for(let l=0;l<i.length-1;l++){const s=g(t,e,i[l].x,i[l].y,i[l+1].x,i[l+1].y);s<h&&(h=s)}return h}function f(){for(const t of o)t.distanceToPath=d(t.x,t.y,a),null!==t.rearAxleX&&null!==t.rearAxleY&&(t.rearAxleDistToPath=d(t.rearAxleX,t.rearAxleY,a)),null!==t.wheelbaseX&&null!==t.wheelbaseY&&(t.wheelbaseDistToPath=d(t.wheelbaseX,t.wheelbaseY,a)),null!==t.frontAxleX&&null!==t.frontAxleY&&(t.frontAxleDistToPath=d(t.frontAxleX,t.frontAxleY,a));console.log("Calculated distances from data points and vehicle parts to path")}let x=0;function u(i){const c=(i-x)/1e3;if(x=i,e.clearRect(0,0,t.width,t.height),n.update(c),l.update(c),s.update(c),e.save(),e.translate(t.width/2,t.height/2),e.scale(h.scale,h.scale),e.translate(-h.x,-h.y),function(){const t=100;e.strokeStyle="#cccccc",e.lineWidth=.1;for(let i=-100;i<=t;i+=10)e.beginPath(),e.moveTo(i,-100),e.lineTo(i,t),e.stroke();for(let i=-100;i<=t;i+=10)e.beginPath(),e.moveTo(-100,i),e.lineTo(t,i),e.stroke();e.strokeStyle="#999999",e.lineWidth=.2,e.beginPath(),e.moveTo(-100,0),e.lineTo(t,0),e.stroke(),e.beginPath(),e.moveTo(0,-100),e.lineTo(0,t),e.stroke()}(),function(){if(0!==a.length)for(const t of a)e.beginPath(),e.arc(t.x,t.y,.1,0,2*Math.PI),e.fillStyle="#e74c3c",e.fill()}(),function(){if(0!==o.length&&r>=0&&r<o.length){const t=o[r],i=.2;if(null!==t.frontAxleX&&null!==t.frontAxleY&&(e.beginPath(),e.arc(t.frontAxleX,t.frontAxleY,i,0,2*Math.PI),e.fillStyle="#9b59b6",e.fill(),null!==t.forwardVectorX&&null!==t.forwardVectorY&&null!==t.steeringAngle)){const i=Math.atan2(t.forwardVectorY,t.forwardVectorX),h=i+Math.PI/2,l=t.steeringAngle*Math.PI/180,s=.3,n=.6;e.save(),e.translate(t.frontAxleX+1*Math.cos(h),t.frontAxleY+1*Math.sin(h)),e.rotate(i+l),e.fillStyle="#2c3e50",e.fillRect(-n/2,-s/2,n,s),e.restore(),e.save(),e.translate(t.frontAxleX-1*Math.cos(h),t.frontAxleY-1*Math.sin(h)),e.rotate(i+l),e.fillStyle="#2c3e50",e.fillRect(-n/2,-s/2,n,s),e.restore()}if(null!==t.rearAxleX&&null!==t.rearAxleY&&(e.beginPath(),e.arc(t.rearAxleX,t.rearAxleY,i,0,2*Math.PI),e.fillStyle="#e67e22",e.fill(),null!==t.forwardVectorX&&null!==t.forwardVectorY)){const i=Math.atan2(t.forwardVectorY,t.forwardVectorX),h=i+Math.PI/2,l=.3,s=.6;e.save(),e.translate(t.rearAxleX+1*Math.cos(h),t.rearAxleY+1*Math.sin(h)),e.rotate(i),e.fillStyle="#2c3e50",e.fillRect(-s/2,-l/2,s,l),e.restore(),e.save(),e.translate(t.rearAxleX-1*Math.cos(h),t.rearAxleY-1*Math.sin(h)),e.rotate(i),e.fillStyle="#2c3e50",e.fillRect(-s/2,-l/2,s,l),e.restore()}if(null!==t.wheelbaseX&&null!==t.wheelbaseY&&(e.beginPath(),e.arc(t.wheelbaseX,t.wheelbaseY,i,0,2*Math.PI),e.fillStyle="#2ecc71",e.fill()),null!==t.forwardVectorX&&null!==t.forwardVectorY){e.strokeStyle="#3c4de7",e.lineWidth=.1,e.beginPath(),e.moveTo(t.x,t.y);const i=1,h=t.x+t.forwardVectorX*i,l=t.y+t.forwardVectorY*i;e.lineTo(h,l),e.stroke();const s=.1,n=Math.atan2(t.forwardVectorY,t.forwardVectorX);e.beginPath(),e.moveTo(h,l),e.lineTo(h-s*Math.cos(n-Math.PI/6),l-s*Math.sin(n-Math.PI/6)),e.lineTo(h-s*Math.cos(n+Math.PI/6),l-s*Math.sin(n+Math.PI/6)),e.closePath(),e.fillStyle="#e74c3c",e.fill()}if(void 0!==t.distanceToPath){if(e.fillStyle="black",e.font="0.3px Arial",null!==t.rearAxleX&&null!==t.rearAxleY){let i="";null!==t.controlPointDistanceToPath&&(i+=`control_point_distance_to_path: ${t.controlPointDistanceToPath.toFixed(2)}`),void 0!==t.rearAxleDistToPath&&(i&&(i+=" | "),i+=`rear_axle_distance_to_path: ${t.rearAxleDistToPath.toFixed(2)}`),e.fillText(i,t.rearAxleX+.2,t.rearAxleY+.2)}if(null!==t.frontAxleX&&null!==t.frontAxleY&&void 0!==t.frontAxleDistToPath){const i=`front_axle_distance_to_path: ${t.frontAxleDistToPath.toFixed(2)}`;e.fillText(i,t.frontAxleX+.2,t.frontAxleY+.2)}if(null!==t.wheelbaseX&&null!==t.wheelbaseY){let i="";void 0!==t.wheelbaseDistToPath&&(i+=`wheelbase_distance_to_path: ${t.wheelbaseDistToPath.toFixed(2)}`),null!==t.acceleration&&(i&&(i+=" | "),i+=`acceleration: ${t.acceleration.toFixed(2)}`),null!==t.steeringAngle&&(i&&(i+=" | "),i+=`steering_angle: ${t.steeringAngle.toFixed(2)}`),e.fillText(i,t.wheelbaseX+.2,t.wheelbaseY+.2)}}e.fillStyle="black",e.font="0.4px Arial",e.fillText(`Position: ${r+1}/${o.length}`,t.x+.2,t.y-.3)}}(),e.restore(),o.length>0&&r>=0&&r<o.length){const t=o[r];h.x=t.x,h.y=t.y}requestAnimationFrame(u)}Promise.all([async function(){try{const t=await fetch("data/path.csv"),e=(await t.text()).split("\n"),i=[];for(let t=1;t<e.length;t++){const h=e[t].trim();if(h){const[t,e]=h.split(";").map(Number);i.push({x:t,y:e})}}console.log(`Loaded ${i.length} points from path.csv`);const h=.05;let l=function(t,e){const i=[];if(t.length>0){let h=0,l=0;const s=new Array(t.length).fill(0);for(s[0]=1,s[t.length-1]=1;-1!==l;){h=-1,l=-1;for(let e=0;e<t.length;e++)if(1===s[e]){if(-1!==h){l=e;break}h=e}let n=-1;if(-1!==l&&h<l-1&&(n=c(t,h,l,e)),-1!==n){for(let e=h+1;e<t.length;e++)0!==s[e]&&s[e]++;s[n]=1}else{i.push(t[h]),s[h]=0;for(let e=l+1;e<t.length;e++)0!==s[e]&&s[e]--}}t.length>0&&(0===i.length||i[i.length-1]!==t[t.length-1])&&i.push(t[t.length-1])}return i}(i,h);console.log(`Simplified path from ${i.length} to ${l.length} points using min_split_distance = ${h}`);const s=1;a=function(t,e){if(t.length<2)return t;const i=[];i.push(t[0]);let h=t[0];for(let l=1;l<t.length;l++){const s=t[l],n=t[l-1],a=Math.sqrt(Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2));if(a>e){const t=Math.floor(a/e);for(let l=1;l<=t;l++){const t=l*e/a,o=n.x+t*(s.x-n.x),r=n.y+t*(s.y-n.y);i.push({x:o,y:r}),h={x:o,y:r}}}(Math.sqrt(Math.pow(s.x-h.x,2)+Math.pow(s.y-h.y,2))>=e||l===t.length-1)&&(i.push(s),h=s)}return i}(l,s),console.log(`Discretized path to ${a.length} points with interval_distance = ${s} meter`),o.length>0&&f()}catch(t){console.error("Error loading path data:",t)}}(),async function(){try{const t=await fetch("data/data.csv"),e=(await t.text()).split("\n");for(let t=1;t<e.length;t++){const i=e[t].trim();if(i){const t=i.split(",");if(t.length>=2){const e=parseFloat(t[0]),i=parseFloat(t[1]),h=t.length>2?parseFloat(t[2]):null,l=t.length>3?parseFloat(t[3]):null,s=t.length>14?parseFloat(t[14]):null,n=t.length>15?parseFloat(t[15]):null,a=t.length>16?parseFloat(t[16]):null,r=t.length>6?parseFloat(t[6]):null,c=t.length>7?parseFloat(t[7]):null,g=t.length>8?parseFloat(t[8]):null,d=t.length>9?parseFloat(t[9]):null,f={x:e,y:i,forwardVectorX:h,forwardVectorY:l,acceleration:s,steeringAngle:n,controlPointDistanceToPath:a,wheelbaseX:r,wheelbaseY:c,frontAxleX:g,frontAxleY:d,rearAxleX:t.length>10?parseFloat(t[10]):null,rearAxleY:t.length>11?parseFloat(t[11]):null};o.push(f)}}}console.log(`Loaded ${o.length} points from data.csv`),a.length>0&&f()}catch(t){console.error("Error loading data points:",t)}}()]).then((()=>{!function(){const t=document.getElementById("positionSlider");t&&o.length>0&&(t.max=o.length-1,t.addEventListener("input",(function(){r=parseInt(this.value)})))}(),requestAnimationFrame(u)}))})();