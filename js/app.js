(()=>{"use strict";const t={x:0,y:0,scale:80,isDragging:!1,lastMouseX:0,lastMouseY:0};let e=[],i=[],h=0;function l(t,e,i,h){if(e>=i-1)return-1;let l=0,n=-1;const a=t[e],o=t[i];for(let r=e+1;r<i;r++){const e=t[r],i=s(e.x,e.y,a.x,a.y,o.x,o.y);i>l&&i>h&&(l=i,n=r)}return n}function s(t,e,i,h,l,s){const n=l-i,a=s-h,o=n*n+a*a;let r,c,g=-1;0!==o&&(g=((t-i)*n+(e-h)*a)/o),g<0?(r=i,c=h):g>1?(r=l,c=s):(r=i+g*n,c=h+g*a);const d=t-r,f=e-c;return Math.sqrt(d*d+f*f)}function n(t,e,i){if(i.length<2)return 1/0;let h=1/0;for(let l=0;l<i.length-1;l++){const n=s(t,e,i[l].x,i[l].y,i[l+1].x,i[l+1].y);n<h&&(h=n)}return h}function a(){for(const t of i)t.distanceToPath=n(t.x,t.y,e),null!==t.rearAxleX&&null!==t.rearAxleY&&(t.rearAxleDistToPath=n(t.rearAxleX,t.rearAxleY,e)),null!==t.wheelbaseX&&null!==t.wheelbaseY&&(t.wheelbaseDistToPath=n(t.wheelbaseX,t.wheelbaseY,e)),null!==t.frontAxleX&&null!==t.frontAxleY&&(t.frontAxleDistToPath=n(t.frontAxleX,t.frontAxleY,e));console.log("Calculated distances from data points and vehicle parts to path")}const o=document.getElementById("simulationCanvas"),r=o.getContext("2d");function c(){o.width=window.innerWidth,o.height=window.innerHeight}window.addEventListener("resize",c),c(),function(e){e.addEventListener("wheel",(i=>{i.preventDefault();const h=i.deltaY>0?.9:1.1,l=e.getBoundingClientRect(),s=i.clientX-l.left,n=i.clientY-l.top,a=(s-e.width/2)/t.scale+t.x,o=(n-e.height/2)/t.scale+t.y;t.scale*=h,t.scale=Math.max(.1,Math.min(t.scale,50)),t.x=a-(s-e.width/2)/t.scale,t.y=o-(n-e.height/2)/t.scale})),e.addEventListener("mousedown",(e=>{2===e.button&&(t.isDragging=!0,t.lastMouseX=e.clientX,t.lastMouseY=e.clientY)})),e.addEventListener("mousemove",(e=>{if(t.isDragging){const i=e.clientX-t.lastMouseX,h=e.clientY-t.lastMouseY;t.x-=i/t.scale,t.y-=h/t.scale,t.lastMouseX=e.clientX,t.lastMouseY=e.clientY}})),e.addEventListener("mouseup",(e=>{2===e.button&&(t.isDragging=!1)})),e.addEventListener("contextmenu",(t=>{t.preventDefault()}))}(o);const g=new class{constructor(){this.x=0,this.y=0,this.heading=0,this.wheelbase=3.8,this.width=2,this.length=this.wheelbase+.6,this.speed=0,this.acceleration=0,this.maxSpeed=20,this.maxAcceleration=5,this.maxDeceleration=8,this.maxSteeringAngle=Math.PI/4,this.steeringAngle=0,this.color="#3498db",this.hitchX=-this.length/2,this.hitchY=0}update(t){if(this.speed+=this.acceleration*t,this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<0&&(this.speed=0),Math.abs(this.speed)>.001){const e=0!==this.steeringAngle?this.wheelbase/Math.tan(this.steeringAngle):1/0,i=this.speed/e;this.heading+=i*t,this.heading=this.heading%(2*Math.PI),this.heading<0&&(this.heading+=2*Math.PI),this.x+=this.speed*Math.cos(this.heading)*t,this.y+=this.speed*Math.sin(this.heading)*t}}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.heading);const e=-this.wheelbase/2,i=this.wheelbase/2;t.fillStyle=this.color,t.fillRect(-this.length/2,-this.width/2,this.length,this.width),t.fillStyle="#e74c3c",t.beginPath(),t.moveTo(this.length/2,0),t.lineTo(this.length/2-.3,-.3),t.lineTo(this.length/2-.3,.3),t.fill();const h=.5,l=.8;t.fillStyle="#2c3e50",t.fillRect(e-.4,-this.width/2-h,l,h),t.fillRect(e-.4,this.width/2,l,h),t.save(),t.translate(i,-this.width/2-.25),t.rotate(this.steeringAngle),t.fillRect(-.4,-.25,l,h),t.restore(),t.save(),t.translate(i,this.width/2+.25),t.rotate(this.steeringAngle),t.fillRect(-.4,-.25,l,h),t.restore(),t.save(),t.translate(this.hitchX,this.hitchY),t.fillStyle="#e74c3c",t.beginPath(),t.arc(0,0,.2,0,2*Math.PI),t.fill(),t.restore(),t.strokeStyle="#3c4de7",t.lineWidth=.1,t.beginPath(),t.moveTo(0,0),t.lineTo(2,0),t.stroke(),t.beginPath(),t.moveTo(2,0),t.lineTo(1.8,-.1),t.lineTo(1.8,.1),t.closePath(),t.fillStyle="#3c4de7",t.fill();const s=.15;t.beginPath(),t.arc(e,0,s,0,2*Math.PI),t.fillStyle="#e67e22",t.fill(),t.beginPath(),t.arc(i,0,s,0,2*Math.PI),t.fillStyle="#9b59b6",t.fill(),t.beginPath(),t.arc(0,0,s,0,2*Math.PI),t.fillStyle="#2ecc71",t.fill(),t.restore()}},d=new class{constructor(t){this.vehicle=t,this.x=t.x-t.length/2-1,this.y=t.y,this.heading=t.heading,this.length=3,this.width=1.8,this.hitchX=this.length/2,this.hitchY=0,this.hitchLength=1,this.color="#27ae60"}update(t){const e=this.vehicle.x+Math.cos(this.vehicle.heading)*this.vehicle.hitchX-Math.sin(this.vehicle.heading)*this.vehicle.hitchY,i=this.vehicle.y+Math.sin(this.vehicle.heading)*this.vehicle.hitchX+Math.cos(this.vehicle.heading)*this.vehicle.hitchY,h=e-(this.x+Math.cos(this.heading)*this.hitchX-Math.sin(this.heading)*this.hitchY),l=i-(this.y+Math.sin(this.heading)*this.hitchX+Math.cos(this.heading)*this.hitchY),s=(Math.sqrt(h*h+l*l),Math.atan2(l,h)),n=s-this.heading,a=Math.atan2(Math.sin(n),Math.cos(n));this.heading+=a*Math.min(1,this.vehicle.speed*t),this.x=e-Math.cos(this.heading)*this.hitchX+Math.sin(this.heading)*this.hitchY-Math.cos(s)*this.hitchLength,this.y=i-Math.sin(this.heading)*this.hitchX-Math.cos(this.heading)*this.hitchY-Math.sin(s)*this.hitchLength}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.heading),t.fillStyle=this.color,t.fillRect(-this.length/2,-this.width/2,this.length,this.width),t.fillStyle="#2c3e50",t.fillRect(-this.length/4,-this.width/2-.3,.8,.3),t.fillRect(-this.length/4,this.width/2,.8,.3),t.fillStyle="#e74c3c",t.beginPath(),t.arc(this.hitchX,this.hitchY,.2,0,2*Math.PI),t.fill(),t.restore(),t.beginPath();const e=this.vehicle.x+Math.cos(this.vehicle.heading)*this.vehicle.hitchX-Math.sin(this.vehicle.heading)*this.vehicle.hitchY,i=this.vehicle.y+Math.sin(this.vehicle.heading)*this.vehicle.hitchX+Math.cos(this.vehicle.heading)*this.vehicle.hitchY,h=this.x+Math.cos(this.heading)*this.hitchX-Math.sin(this.heading)*this.hitchY,l=this.y+Math.sin(this.heading)*this.hitchX+Math.cos(this.heading)*this.hitchY;t.strokeStyle="#7f8c8d",t.lineWidth=.1,t.moveTo(e,i),t.lineTo(h,l),t.stroke()}}(g),f=new class{constructor(t){this.vehicle=t,this.keys={ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1," ":!1},window.addEventListener("keydown",(t=>this.handleKeyDown(t))),window.addEventListener("keyup",(t=>this.handleKeyUp(t)))}handleKeyDown(t){this.keys.hasOwnProperty(t.key)&&(this.keys[t.key]=!0,t.preventDefault())}handleKeyUp(t){this.keys.hasOwnProperty(t.key)&&(this.keys[t.key]=!1,t.preventDefault())}update(t){this.keys.ArrowLeft&&!this.keys.ArrowRight?this.vehicle.steeringAngle=-this.vehicle.maxSteeringAngle:this.keys.ArrowRight&&!this.keys.ArrowLeft?this.vehicle.steeringAngle=this.vehicle.maxSteeringAngle:this.vehicle.steeringAngle=0,this.keys[" "]?this.vehicle.acceleration=-this.vehicle.maxDeceleration:this.keys.ArrowUp&&!this.keys.ArrowDown?this.vehicle.acceleration=this.vehicle.maxAcceleration:this.keys.ArrowDown&&!this.keys.ArrowUp?this.vehicle.acceleration=-this.vehicle.maxDeceleration:Math.abs(this.vehicle.speed)<.1?(this.vehicle.acceleration=0,this.vehicle.speed=0):this.vehicle.acceleration=2*-Math.sign(this.vehicle.speed)}}(g);let u=0;function x(l){const s=(l-u)/1e3;if(u=l,r.clearRect(0,0,o.width,o.height),f.update(s),g.update(s),d.update(s),function(e,i){e.save(),e.translate(i.width/2,i.height/2),e.scale(t.scale,t.scale),e.translate(-t.x,-t.y)}(r,o),function(t){const e=100;t.strokeStyle="#cccccc",t.lineWidth=.1;for(let i=-100;i<=e;i+=5)t.beginPath(),t.moveTo(i,-100),t.lineTo(i,e),t.stroke();for(let i=-100;i<=e;i+=5)t.beginPath(),t.moveTo(-100,i),t.lineTo(e,i),t.stroke();t.strokeStyle="#999999",t.lineWidth=.2,t.beginPath(),t.moveTo(-100,0),t.lineTo(e,0),t.stroke(),t.beginPath(),t.moveTo(0,-100),t.lineTo(0,e),t.stroke()}(r),function(t){if(0!==e.length)for(const i of e)t.beginPath(),t.arc(i.x,i.y,.1,0,2*Math.PI),t.fillStyle="#e74c3c",t.fill()}(r),function(t){if(0!==i.length&&h>=0&&h<i.length){const e=i[h],l=.2;if(null!==e.frontAxleX&&null!==e.frontAxleY&&(t.beginPath(),t.arc(e.frontAxleX,e.frontAxleY,l,0,2*Math.PI),t.fillStyle="#9b59b6",t.fill(),null!==e.forwardVectorX&&null!==e.forwardVectorY&&null!==e.steeringAngle)){const i=Math.atan2(e.forwardVectorY,e.forwardVectorX),h=i+Math.PI/2,l=e.steeringAngle*Math.PI/180,s=.3,n=.6;t.save(),t.translate(e.frontAxleX+1*Math.cos(h),e.frontAxleY+1*Math.sin(h)),t.rotate(i+l),t.fillStyle="#2c3e50",t.fillRect(-n/2,-s/2,n,s),t.restore(),t.save(),t.translate(e.frontAxleX-1*Math.cos(h),e.frontAxleY-1*Math.sin(h)),t.rotate(i+l),t.fillStyle="#2c3e50",t.fillRect(-n/2,-s/2,n,s),t.restore()}if(null!==e.rearAxleX&&null!==e.rearAxleY&&(t.beginPath(),t.arc(e.rearAxleX,e.rearAxleY,l,0,2*Math.PI),t.fillStyle="#e67e22",t.fill(),null!==e.forwardVectorX&&null!==e.forwardVectorY)){const i=Math.atan2(e.forwardVectorY,e.forwardVectorX),h=i+Math.PI/2,l=.3,s=.6;t.save(),t.translate(e.rearAxleX+1*Math.cos(h),e.rearAxleY+1*Math.sin(h)),t.rotate(i),t.fillStyle="#2c3e50",t.fillRect(-s/2,-l/2,s,l),t.restore(),t.save(),t.translate(e.rearAxleX-1*Math.cos(h),e.rearAxleY-1*Math.sin(h)),t.rotate(i),t.fillStyle="#2c3e50",t.fillRect(-s/2,-l/2,s,l),t.restore()}if(null!==e.wheelbaseX&&null!==e.wheelbaseY&&(t.beginPath(),t.arc(e.wheelbaseX,e.wheelbaseY,l,0,2*Math.PI),t.fillStyle="#2ecc71",t.fill()),null!==e.forwardVectorX&&null!==e.forwardVectorY){t.strokeStyle="#3c4de7",t.lineWidth=.1,t.beginPath(),t.moveTo(e.x,e.y);const i=1,h=e.x+e.forwardVectorX*i,l=e.y+e.forwardVectorY*i;t.lineTo(h,l),t.stroke();const s=.1,n=Math.atan2(e.forwardVectorY,e.forwardVectorX);t.beginPath(),t.moveTo(h,l),t.lineTo(h-s*Math.cos(n-Math.PI/6),l-s*Math.sin(n-Math.PI/6)),t.lineTo(h-s*Math.cos(n+Math.PI/6),l-s*Math.sin(n+Math.PI/6)),t.closePath(),t.fillStyle="#e74c3c",t.fill()}if(void 0!==e.distanceToPath){if(t.fillStyle="black",t.font="0.3px Arial",null!==e.rearAxleX&&null!==e.rearAxleY){let i="";null!==e.controlPointDistanceToPath&&(i+=`control_point_distance_to_path: ${e.controlPointDistanceToPath.toFixed(2)}`),void 0!==e.rearAxleDistToPath&&(i&&(i+=" | "),i+=`rear_axle_distance_to_path: ${e.rearAxleDistToPath.toFixed(2)}`),t.fillText(i,e.rearAxleX+.2,e.rearAxleY+.2)}if(null!==e.frontAxleX&&null!==e.frontAxleY&&void 0!==e.frontAxleDistToPath){const i=`front_axle_distance_to_path: ${e.frontAxleDistToPath.toFixed(2)}`;t.fillText(i,e.frontAxleX+.2,e.frontAxleY+.2)}if(null!==e.wheelbaseX&&null!==e.wheelbaseY){let i="";void 0!==e.wheelbaseDistToPath&&(i+=`wheelbase_distance_to_path: ${e.wheelbaseDistToPath.toFixed(2)}`),null!==e.acceleration&&(i&&(i+=" | "),i+=`acceleration: ${e.acceleration.toFixed(2)}`),null!==e.steeringAngle&&(i&&(i+=" | "),i+=`steering_angle: ${e.steeringAngle.toFixed(2)}`),t.fillText(i,e.wheelbaseX+.2,e.wheelbaseY+.2)}}t.fillStyle="black",t.font="0.4px Arial",t.fillText(`Position: ${h+1}/${i.length}`,e.x+.2,e.y-.3)}}(r),function(t){t.restore()}(r),i.length>0&&h>=0&&h<i.length){const e=i[h];t.x=e.x,t.y=e.y}requestAnimationFrame(x)}Promise.all([async function(){try{const t=await fetch("data/path.csv"),h=(await t.text()).split("\n"),s=[];for(let t=1;t<h.length;t++){const e=h[t].trim();if(e){const[t,i]=e.split(";").map(Number);s.push({x:t,y:i})}}console.log(`Loaded ${s.length} points from path.csv`);const n=.05;let o=function(t,e){const i=[];if(t.length>0){let h=0,s=0;const n=new Array(t.length).fill(0);for(n[0]=1,n[t.length-1]=1;-1!==s;){h=-1,s=-1;for(let e=0;e<t.length;e++)if(1===n[e]){if(-1!==h){s=e;break}h=e}let a=-1;if(-1!==s&&h<s-1&&(a=l(t,h,s,e)),-1!==a){for(let e=h+1;e<t.length;e++)0!==n[e]&&n[e]++;n[a]=1}else{i.push(t[h]),n[h]=0;for(let e=s+1;e<t.length;e++)0!==n[e]&&n[e]--}}t.length>0&&(0===i.length||i[i.length-1]!==t[t.length-1])&&i.push(t[t.length-1])}return i}(s,n);console.log(`Simplified path from ${s.length} to ${o.length} points using min_split_distance = ${n}`);const r=1;e=function(t,e){if(t.length<2)return t;const i=[];i.push(t[0]);let h=t[0];for(let l=1;l<t.length;l++){const s=t[l],n=t[l-1],a=Math.sqrt(Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2));if(a>e){const t=Math.floor(a/e);for(let l=1;l<=t;l++){const t=l*e/a,o=n.x+t*(s.x-n.x),r=n.y+t*(s.y-n.y);i.push({x:o,y:r}),h={x:o,y:r}}}(Math.sqrt(Math.pow(s.x-h.x,2)+Math.pow(s.y-h.y,2))>=e||l===t.length-1)&&(i.push(s),h=s)}return i}(o,r),console.log(`Discretized path to ${e.length} points with interval_distance = ${r} meter`),i.length>0&&a()}catch(t){console.error("Error loading path data:",t)}}(),async function(){try{const t=await fetch("data/data.csv"),h=(await t.text()).split("\n");for(let t=1;t<h.length;t++){const e=h[t].trim();if(e){const t=e.split(",");if(t.length>=2){const e=parseFloat(t[0]),h=parseFloat(t[1]),l=t.length>2?parseFloat(t[2]):null,s=t.length>3?parseFloat(t[3]):null,n=t.length>14?parseFloat(t[14]):null,a=t.length>15?parseFloat(t[15]):null,o=t.length>16?parseFloat(t[16]):null,r=t.length>6?parseFloat(t[6]):null,c=t.length>7?parseFloat(t[7]):null,g=t.length>8?parseFloat(t[8]):null,d=t.length>9?parseFloat(t[9]):null,f={x:e,y:h,forwardVectorX:l,forwardVectorY:s,acceleration:n,steeringAngle:a,controlPointDistanceToPath:o,wheelbaseX:r,wheelbaseY:c,frontAxleX:g,frontAxleY:d,rearAxleX:t.length>10?parseFloat(t[10]):null,rearAxleY:t.length>11?parseFloat(t[11]):null};i.push(f)}}}console.log(`Loaded ${i.length} points from data.csv`),e.length>0&&a()}catch(t){console.error("Error loading data points:",t)}}()]).then((()=>{!function(){const t=document.getElementById("positionSlider");t&&i.length>0&&(t.max=i.length-1,t.addEventListener("input",(function(){h=parseInt(this.value)})))}(),requestAnimationFrame(x)}))})();